{% extends "base.html" %}
{% load i18n static %}

{% block title %}{% trans "Sign in" %} — {{ site_name }}{% endblock %}
{% block meta_description %}{% trans "Sign in to manage your CoolVPN subscription." %}{% endblock %}
{% block meta_robots %}noindex,nofollow{% endblock %}

{% block header %}
  {% include "partials/navbar.html" %}
{% endblock %}

{% block content %}
<section class="relative flex h-[100vh] items-center justify-center isolate overflow-hidden bg-white dark:bg-neutral-950">
  <!-- arka plan bloblar -->
  <div class="pointer-events-none absolute inset-0 -z-10">
    <div class="absolute -top-24 -left-24 h-72 w-72 rounded-full blur-3xl bg-rose-300/30 dark:bg-rose-400/20"></div>
    <div class="absolute bottom-0 right-1/4 h-72 w-72 rounded-full blur-3xl bg-fuchsia-300/25 dark:bg-fuchsia-400/20"></div>
    <div class="absolute top-1/3 left-1/2 -translate-x-1/2 h-64 w-64 rounded-full blur-3xl bg-indigo-300/20 dark:bg-indigo-400/15"></div>
  </div>

  <!-- ORTALAMA: min-h-screen + flex center -->
  <div class="min-h-[calc(100vh-6rem)] md:min-h-[calc(100vh-8rem)] flex items-center justify-center py-10 md:py-16">
    <div class="w-full max-w-screen-sm mx-auto px-6">
      <div class="rounded-3xl border border-black/10 dark:border-white/10 bg-white/60 dark:bg-white/[0.04] backdrop-blur-xl shadow-xl overflow-hidden relative group">
        <div class="absolute inset-0 pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity duration-500"
             style="background: radial-gradient(1200px 300px at 20% 0%, rgba(244,114,182,.12), transparent 60%), radial-gradient(800px 240px at 80% 100%, rgba(167,139,250,.10), transparent 60%);"></div>

        <!-- Header -->
        <div class="px-6 md:px-8 pt-7 pb-4">
          <div class="flex items-center gap-3">
            <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-rose-500/80 to-fuchsia-500/80 shadow-md flex items-center justify-center">
              <svg viewBox="0 0 24 24" class="h-6 w-6 text-emerald-400" fill="currentColor" aria-hidden="true">
                <path d="M12 2.5L4.5 5v6.7c0 5 3.6 9.6 7.5 9.8c3.9-.2 7.5-4.8 7.5-9.8V5L12 2.5zM10.9 16.2l-3.1-3.1 1.4-1.4 1.7 1.7 4-4 1.4 1.4-5.4 5.4z" />
              </svg>
            </div>
            <div>
              <h1 class="text-xl md:text-2xl font-semibold tracking-tight text-gray-900 dark:text-gray-100">{% trans "Sign in" %}</h1>
              <p class="text-xs md:text-sm text-gray-600 dark:text-gray-300">{% trans "Access your dashboard and subscriptions." %}</p>
            </div>
          </div>
        </div>

        <!-- Body -->
        <div class="px-6 md:px-8 pb-7">
          <form id="login-form" class="space-y-4" onsubmit="return false;">
            {% csrf_token %}
            <input type="hidden" id="next" value="{{ next|default:'/' }}"/>

            <div>
              <label for="email" class="block text-xs font-medium text-gray-900 dark:text-gray-100 mb-1">{% trans "Email" %}</label>
              <input id="email" type="email" autocomplete="email" inputmode="email"
                     class="w-full rounded-xl bg-white/90 dark:bg-white/[0.06] ring-1 ring-black/10 dark:ring-white/10 px-3 py-2 text-gray-900 dark:text-gray-100 placeholder:text-gray-500 dark:placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-rose-400/60 transition"
                     placeholder="you@example.com">
              <div id="email-hint" class="mt-1 text-[11px] text-gray-600 dark:text-gray-400"></div>
            </div>

            <div id="password-wrap">
              <label for="password" class="block text-xs font-medium text-gray-900 dark:text-gray-100 mb-1">{% trans "Password" %}</label>
              <div class="relative">
                <input id="password" type="password" autocomplete="current-password"
                       class="w-full pr-10 rounded-xl bg-white/90 dark:bg-white/[0.06] ring-1 ring-black/10 dark:ring-white/10 px-3 py-2 text-gray-900 dark:text-gray-100 placeholder:text-gray-500 dark:placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-rose-400/60 transition"
                       placeholder="{% trans 'Your password' %}">
                <button id="btn-toggle-pass" type="button"
                        class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200"
                        aria-label="{% trans 'Show password' %}">
                  <svg id="icon-eye" viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="1.8">
                    <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12Z"/><circle cx="12" cy="12" r="3"/>
                  </svg>
                  <svg id="icon-eye-off" viewBox="0 0 24 24" class="h-5 w-5 hidden" fill="none" stroke="currentColor" stroke-width="1.8">
                    <path d="M3 3l18 18M10.6 10.6A3 3 0 0 0 12 15a3 3 0 0 0 2.4-4.4M4.5 7.5S8 5 12 5s7.5 2.5 7.5 2.5c1.2.9 2.5 2.1 3.5 4.5-1 2.4-2.3 3.6-3.5 4.5 0 0-3.5 2.5-7.5 2.5S4.5 17 4.5 17C3.3 16.1 2 14.9 1 12.5"/>
                  </svg>
                </button>
              </div>
              <p class="mt-1 text-[11px] text-gray-600 dark:text-gray-400" id="pass-hint"></p>
            </div>

            <div class="flex items-center justify-between pt-2">
              <button id="btn-email-login" class="inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-medium
                      text-white bg-gray-900 hover:bg-gray-800 active:bg-black
                      dark:bg-white dark:text-black dark:hover:bg-white/90 transition">
                {% trans "Sign in" %}
              </button>

              <a href="/password-reset/" class="text-xs underline text-gray-600 dark:text-gray-300">{% trans "Forgot password?" %}</a>
            </div>

            <div class="relative my-4">
              <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-black/10 dark:border-white/10"></div></div>
              <div class="relative flex justify-center">
                <span class="bg-white/90 dark:bg-neutral-950 px-2 text-[11px] uppercase tracking-wide text-gray-500">{% trans "or" %}</span>
              </div>
            </div>

            <div>
              <button id="btn-google-open" type="button"
                      class="w-full inline-flex items-center justify-center gap-2 rounded-xl px-4 py-2 text-sm font-medium
                             text-white bg-gradient-to-r from-rose-600 via-fuchsia-600 to-indigo-600
                             hover:opacity-95 active:opacity-100 transition shadow-md">
                <svg width="18" height="18" viewBox="0 0 48 48" class="opacity-95">
                  <path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3C33.5 32.7 29.1 36 24 36 16.8 36 11 30.2 11 23S16.8 10 24 10c3.4 0 6.5 1.3 8.8 3.5l5.7-5.7C34.7 4.1 29.7 2 24 2 15 2 7.6 6.7 3.7 14.7z"/>
                  <path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.4 16 18.9 13 24 13c3.4 0 6.5 1.3 8.8 3.5l5.7-5.7C34.7 4.1 29.7 2 24 2 15 2 7.6 6.7 3.7 14.7z"/>
                  <path fill="#4CAF50" d="M24 46c5.1 0 10-1.9 13.6-5.2l-6.3-5.2C29 37.4 26.7 38 24 38c-5 0-9.3-3.2-10.9-7.7l-6.6 5.1C8.6 39.9 15.8 46 24 46z"/>
                  <path fill="#1976D2" d="M43.6 20.5H42V20H24v8h11.3C34.8 32 30.8 36 24 36c-5 0-9.3-3.2-10.9-7.7l-6.6 5.1C8.6 39.9 15.8 46 24 46c11 0 21-8 21-22 0-1.2-.1-2.3-.4-3.5z"/>
                </svg>
                {% trans "Continue with Google" %}
              </button>
              <!-- gerçek Google butonu buraya offscreen render edilecek -->
              <div id="google-btn-slot-inline" class="hidden"></div>
            </div>

            <div id="form-alert" class="mt-2 text-sm text-rose-600 dark:text-rose-400" aria-live="polite"></div>
          </form>
        </div>
      </div>

      <p class="mt-4 text-center text-xs text-gray-600 dark:text-gray-300">
        {% trans "Don’t have an account?" %} <a href="/auth/login/?next={{ next|urlencode }}" class="underline">{% trans "Create it by signing in — we’ll set it up automatically." %}</a>
      </p>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
{{ block.super }}

<style>
  /* One Tap overlay hep en üstte kalsın */
  #credential_picker_container,
  .credential_picker_container,
  .nsm7Bb { z-index: 2147483647 !important; }
</style>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
  const qs=(s,r=document)=>r.querySelector(s);
  const getCookie=(name)=>(document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)')||[]).pop()||'';
  const nextUrl = qs('#next')?.value || '/';

  // Password toggle
  (function(){
    const btn=qs('#btn-toggle-pass'), input=qs('#password'), eye=qs('#icon-eye'), off=qs('#icon-eye-off');
    if(!btn||!input) return;
    btn.addEventListener('click', ()=>{
      const show = input.type === 'password';
      input.type = show? 'text':'password';
      eye?.classList.toggle('hidden', !show);
      off?.classList.toggle('hidden', show);
      btn.setAttribute('aria-label', show ? 'Hide password' : 'Show password');
    });
  })();

  function showFormAlert(msg){ const el=qs('#form-alert'); if(el){ el.textContent = msg || ''; } }

  // Email hint
  async function checkEmail(email){
    if(!email || !email.includes('@')) return;
    try{
      const r = await fetch('/auth/check-email/', {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded','X-CSRFToken': getCookie('csrftoken')||''},
        body: new URLSearchParams({email})
      });
      const d = await r.json();
      const el = qs('#email-hint');
      if(d?.ok && el){
        el.textContent = d.exists
          ? "{{ _('Account found. Enter your password to sign in.') }}"
          : "{{ _('No account found. We will create one after you set a password.') }}";
      }
    }catch(_){}
  }
  qs('#email')?.addEventListener('input', (e)=> {
    const v=(e.target.value||'').trim();
    if(v.includes('@')) checkEmail(v);
  });

  // Email login/upsert
  async function emailLogin(){
    const email = (qs('#email')?.value||'').trim();
    const pass  = (qs('#password')?.value||'');
    if(!email || !email.includes('@')) { showFormAlert("{{ _('Please enter a valid email.') }}"); return; }
    if(!pass || pass.length < 6){ showFormAlert("{{ _('Please enter your password (min 6 chars).') }}"); return; }
    try{
      const r = await fetch('/auth/email-upsert-login/', {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded','X-CSRFToken': getCookie('csrftoken')||''},
        body: new URLSearchParams({email, password: pass}),
        credentials:'same-origin'
      });
      const d = await r.json();
      if(d?.ok){ location.href = nextUrl || '/'; }
      else{ showFormAlert(d?.error === 'invalid_credentials' ? "{{ _('Invalid email or password.') }}" : "{{ _('Sign-in failed. Try again.') }}"); }
    }catch(_){ showFormAlert("{{ _('Network problem. Try again.') }}"); }
  }
  qs('#btn-email-login')?.addEventListener('click', emailLogin);

  // Google Popup
  let gisReady = false, inlineBtnRendered = false;
  function initGIS(){
    if(gisReady) return true;
    if(!(window.google && google.accounts && google.accounts.id)) return false;
    google.accounts.id.initialize({
      client_id: "{{ GOOGLE_CLIENT_ID }}",
      callback: onGoogleCredential,
      ux_mode: "popup",
      auto_select: false,
      context: "signin"
    });
    gisReady = true;
    return true;
  }
  async function finishWithToken(idToken){
    const r = await fetch('/auth/google/finish/', {
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded','X-CSRFToken': getCookie('csrftoken')||''},
      body: new URLSearchParams({credential: idToken})
    });
    return r.json();
  }
  window.onGoogleCredential = async function(resp){
    if(!resp || !resp.credential) return;
    try{
      const d = await finishWithToken(resp.credential);
      if(d?.ok){ location.href = nextUrl || '/'; }
      else{ showFormAlert(d?.error || "{{ _('Google sign-in failed.') }}"); }
    }catch(_){ showFormAlert("{{ _('Google sign-in failed.') }}"); }
  };
  function tryGooglePopup(){
    showFormAlert('');
    if(!initGIS()){ showFormAlert("{{ _('Google is not ready. Please try again.') }}"); return; }
    const slot = document.getElementById('google-btn-slot-inline');
    if(slot){
      slot.classList.remove('hidden');
      slot.style.position = 'fixed';
      slot.style.top = '-10000px';
      slot.style.left = '-10000px';
      slot.style.opacity = '0';
      slot.style.pointerEvents = 'none';
    }
    if(slot && !inlineBtnRendered){
      google.accounts.id.renderButton(
        slot,
        { type:"standard", size:"large", theme:"outline", shape:"pill", text:"continue_with", logo_alignment:"left" }
      );
      inlineBtnRendered = true;
    }
    const realBtn = slot?.querySelector('div[role="button"], .nsm7Bb-HzV7m-LgbsSe');
    if(realBtn){ try { realBtn.click(); } catch(e){ showFormAlert("{{ _('Could not open Google popup.') }}"); } }
    else{ showFormAlert("{{ _('Google is not ready. Please try again.') }}"); }
  }
  qs('#btn-google-open')?.addEventListener('click', tryGooglePopup);

  // script yüklenmesini bekle
  let tries=0;
  const iv=setInterval(()=>{
    tries++;
    if(initGIS()) clearInterval(iv);
    if(tries>40) clearInterval(iv);
  }, 100);
</script>
{% endblock %}
