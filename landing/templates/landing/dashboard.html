{% extends "base.html" %}
{% load i18n static %}

{% block title %}{% trans "Dashboard" %} — {{ site_name }}{% endblock %}
{% block meta_robots %}noindex,nofollow{% endblock %}

{% block header %}
  {% include "partials/navbar.html" %}
{% endblock %}

{% block content %}
<section class="relative flex h-[100vh] items-center justify-center isolate overflow-hidden bg-white dark:bg-neutral-950 py-10 md:py-14">
  <!-- soft glows -->
  <div class="pointer-events-none absolute inset-0 -z-10">
    <div class="absolute -top-24 -left-24 h-72 w-72 rounded-full blur-3xl bg-rose-300/30 dark:bg-rose-400/20"></div>
    <div class="absolute bottom-0 right-1/4 h-72 w-72 rounded-full blur-3xl bg-fuchsia-300/25 dark:bg-fuchsia-400/20"></div>
    <div class="absolute top-1/3 left-1/2 -translate-x-1/2 h-64 w-64 rounded-full blur-3xl bg-indigo-300/20 dark:bg-indigo-400/15"></div>
  </div>

  <div class="max-w-screen-xl mx-auto px-6">
    <div class="grid gap-6 lg:grid-cols-3">
      <!-- LEFT: STATUS / SUBSCRIPTION -->
      <div class="lg:col-span-1 rounded-3xl border border-black/10 dark:border-white/10 bg-white/60 dark:bg-white/[0.04] backdrop-blur-xl shadow-xl p-6">
        <div class="flex items-center gap-3">
          <div class="relative">
            <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-rose-500/80 to-fuchsia-500/80 shadow-md flex items-center justify-center">
              <svg viewBox="0 0 24 24" class="h-6 w-6 text-emerald-400" fill="currentColor" aria-hidden="true">
                <path d="M12 2.5L4.5 5v6.7c0 5 3.6 9.6 7.5 9.8c3.9-.2 7.5-4.8 7.5-9.8V5L12 2.5zM10.9 16.2l-3.1-3.1 1.4-1.4 1.7 1.7 4-4 1.4 1.4-5.4 5.4z" />
              </svg>
            </div>
            {% if active_sub %}
            <!-- live green dot -->
            <span class="absolute -right-1 -top-1 inline-flex h-3 w-3">
              <span class="absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75 animate-ping"></span>
              <span class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span>
            </span>
            {% endif %}
          </div>
          <div>
            <h2 class="text-sm font-semibold text-gray-900 dark:text-gray-100">{% trans "Account status" %}</h2>
            <p class="text-xs text-gray-600 dark:text-gray-300">
              {% if active_sub %}
                <span class="inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[11px] font-medium bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300">
                  ● {% trans "Premium" %}
                </span>
                <span class="ml-1">{{ plan_key|title }}</span>
              {% else %}
                <span class="inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[11px] font-medium bg-gray-100 text-gray-700 dark:bg-white/10 dark:text-gray-200">
                  ● {% trans "Free" %}
                </span>
              {% endif %}
            </p>
          </div>
        </div>

        {% if active_sub %}
        <!-- Circular progress ring -->
        <div class="mt-6 flex items-center justify-center">
          <div
            id="sub-ring"
            class="relative h-44 w-44 rounded-full"
            style="
              --pct: {{ progress_pct|default:0 }};
              background:
                conic-gradient(#10b981 calc(var(--pct)*1%), rgba(16,185,129,.15) 0);
            ">
            <div class="absolute inset-2 rounded-full bg-white/70 dark:bg-neutral-900/60 backdrop-blur"></div>
            <div class="absolute inset-0 grid place-items-center">
              <div class="text-center">
                <div class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">{% trans "Time left" %}</div>
                <div id="countdown" class="mt-1 text-2xl font-bold text-gray-900 dark:text-gray-100">
                  {{ days_left }}d {{ hours_left }}h
                </div>
                <div class="mt-2 text-[11px] text-gray-600 dark:text-gray-400">
                  {% trans "Ends" %} {{ ends_at|date:"Y-m-d H:i" }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- linear fallback bar + dates -->
        <div class="mt-5 space-y-2 text-sm text-gray-800 dark:text-gray-300">
          <div class="flex justify-between"><span>{% trans "Started" %}</span><span>{{ starts_at|date:"Y-m-d H:i" }}</span></div>
          <div class="flex justify-between"><span>{% trans "Ends" %}</span><span>{{ ends_at|date:"Y-m-d H:i" }}</span></div>
          <div class="mt-2 h-2 rounded-full bg-gray-200 dark:bg-white/10 overflow-hidden">
            <div id="bar-progress" class="h-full bg-gradient-to-r from-emerald-500 via-teal-500 to-indigo-500 transition-[width] duration-500" style="width: {{ progress_pct }}%"></div>
          </div>
        </div>
        {% else %}
        <div class="mt-5 text-sm text-gray-800 dark:text-gray-300">
          <p class="text-sm">{% trans "Upgrade to unlock Premium features and higher device limits." %}</p>
          <a href="{% url 'pricing' %}" class="mt-3 inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-medium text-white bg-gray-900 hover:bg-gray-800 dark:bg-white dark:text-black">
            {% trans "View plans" %}
          </a>
        </div>
        {% endif %}

        <!-- Device limit -->
        <div class="mt-6 text-sm text-gray-800 dark:text-gray-300">
          <div class="flex items-center justify-between">
            <span>{% trans "Device limit" %}</span>
            <span class="font-semibold">{{ used_count }}/{{ device_cap }}</span>
          </div>
          {% if remaining > 0 %}
            <p class="text-[11px] text-gray-600 dark:text-gray-400 mt-1">
              {% blocktrans %}You can add {{ remaining }} more device{{ remaining|pluralize }}.{% endblocktrans %}
            </p>
          {% else %}
            <p class="text-[11px] text-rose-600 dark:text-rose-400 mt-1">{% trans "Limit reached. Revoke a device to add another." %}</p>
          {% endif %}
        </div>
      </div>

      <!-- RIGHT: DEVICES -->
      <div class="lg:col-span-2 rounded-3xl border border-black/10 dark:border-white/10 bg-white/60 dark:bg-white/[0.04] backdrop-blur-xl shadow-xl p-6">
        <div class="flex items-center justify-between">
          <h3 class="text-sm font-semibold text-gray-900 dark:text-gray-100">{% trans "Your devices" %}</h3>
          <a href="/apps" class="text-xs underline text-gray-600 dark:text-gray-300">{% trans "Get the app" %}</a>
        </div>

        <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
          {% for d in devices %}
          <div class="rounded-xl ring-1 ring-black/10 dark:ring-white/10 p-3 bg-white/80 dark:bg-white/[0.05] {% if not d.is_active %}opacity-60{% endif %}">
            <div class="flex items-start gap-3">
              <div class="h-9 w-9 rounded-lg bg-white dark:bg-white/10 ring-1 ring-black/10 dark:ring-white/10 grid place-items-center">
                {% if d.platform == 'windows' %}
                  <svg viewBox="0 0 24 24" class="h-5 w-5"><path fill="currentColor" d="M3 5.5l8-1.4v7H3zm9 5.6h9v-9l-9 1.6zm-9 1.3h8v7l-8-1.4zm9 0v7l9 1.6v-9z"/></svg>
                {% elif d.platform == 'mac' or d.platform == 'macos' %}
                  <svg viewBox="0 0 24 24" class="h-5 w-5"><path fill="currentColor" d="M17 2c-.9.6-2 .9-3.1.9C12.4 3 11 4.4 11 6c0 .3 0 .6.1.9c-2-.1-3.8-1.1-5-2.7C5.5 5 .8 9.6 3.4 14c1.1 1.8 2.8 3 4.8 3c1.2 0 2.3-.4 3.2-1.1c.7.8 1.7 1.1 2.6 1.1c1 0 2-.4 2.9-1.2c-.7-.5-1.5-1.4-1.5-2.7c0-1.5 1.2-2.2 1.9-2.6c-.9-1.3-2.2-2-3.6-2.1c.2-.4.3-.9.3-1.4C14 4.3 15.3 3 17 2z"/></svg>
                {% elif d.platform == 'linux' %}
                  <svg viewBox="0 0 24 24" class="h-5 w-5"><path fill="currentColor" d="M12 2c-1.7 0-3 1.3-3 3v2.2C7.4 8 6 10.2 6 12.8C6 16.8 8.7 20 12 20s6-3.2 6-7.2c0-2.6-1.4-4.8-3-5.6V5c0-1.7-1.3-3-3-3z"/></svg>
                {% elif d.platform == 'android' %}
                  <svg viewBox="0 0 24 24" class="h-5 w-5"><path fill="currentColor" d="M17.6 9H6.4c-.8 0-1.4.6-1.4 1.4V18c0 .8.6 1.4 1.4 1.4h11.2c.8 0 1.4-.6 1.4-1.4v-7.6c0-.8-.6-1.4-1.4-1.4zM8 4l1.2 1.8m6.8-1.8L14.8 6"/></svg>
                {% elif d.platform == 'ios' or d.platform == 'iphone' %}
                  <svg viewBox="0 0 24 24" class="h-5 w-5"><rect x="7" y="2" width="10" height="20" rx="3" ry="3" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
                {% elif d.platform == 'browser' %}
                  <svg viewBox="0 0 24 24" class="h-5 w-5"><path fill="currentColor" d="M3 5h18v14H3zm0 2v2h18V7z"/></svg>
                {% else %}
                  <svg viewBox="0 0 24 24" class="h-5 w-5"><path fill="currentColor" d="M6 4h12v16H6z"/></svg>
                {% endif %}
              </div>
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2">
                  <span class="text-sm font-semibold text-gray-900 dark:text-gray-100 truncate">
                    {{ d.name|default:"Unnamed device" }}
                  </span>
                  {% if not d.is_active %}
                    <span class="text-[10px] px-1.5 py-0.5 rounded bg-gray-100 dark:bg-white/10 text-gray-600 dark:text-gray-300">revoked</span>
                  {% endif %}
                </div>
                <div class="text-xs text-gray-600 dark:text-gray-400 truncate">
                  {{ d.platform|capfirst }}{% if d.os_version %} • {{ d.os_version }}{% endif %}
                </div>
                <div class="text-[11px] text-gray-500 dark:text-gray-400 mt-0.5">
                  {% trans "Last seen" %}: {{ d.last_seen|date:"Y-m-d H:i" }}
                </div>
              </div>
            </div>

            <div class="mt-3">
              {% if d.is_active %}
                <form method="post" action="{% url 'device_revoke' %}" onsubmit="return revokeDevice('{{ d.uuid }}', this);">
                  {% csrf_token %}
                  <button class="w-full text-xs rounded-lg px-3 py-1.5 ring-1 ring-black/10 dark:ring-white/10 hover:bg-gray-50 dark:hover:bg-white/10 transition">
                    {% trans "Revoke" %}
                  </button>
                </form>
              {% else %}
                <span class="text-[11px] text-gray-500 dark:text-gray-400">{% trans "This device cannot connect." %}</span>
              {% endif %}
            </div>
          </div>
          {% empty %}
          <div class="col-span-full text-sm text-gray-700 dark:text-gray-300">
            {% trans "No devices yet. Install the app and sign in to link your first device." %}
          </div>
          {% endfor %}
        </div>

        {% if remaining <= 0 %}
          <div class="mt-4 text-[11px] text-rose-600 dark:text-rose-400">{% trans "You’ve reached your device limit." %}</div>
        {% endif %}
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
  // Revoke helper
  async function revokeDevice(uuid, formEl){
    const body = new URLSearchParams({uuid});
    const token = formEl.querySelector('input[name="csrfmiddlewaretoken"]')?.value || '';
    try{
      const r = await fetch("{% url 'device_revoke' %}", {
        method: "POST",
        headers: {"Content-Type":"application/x-www-form-urlencoded", "X-CSRFToken": token},
        body: body.toString(),
        credentials: "same-origin"
      });
      const d = await r.json();
      if(d?.ok){ location.reload(); return false; }
      alert(d?.error || "Failed"); return false;
    }catch(e){
      alert("Network error"); return false;
    }
  }

  // Live countdown + ring animation (only if premium)
  (function(){
    const endIso = "{{ ends_at|date:'c' }}";
    const startIso = "{{ starts_at|date:'c' }}";
    if(!endIso || !startIso) return;

    const end = new Date(endIso).getTime();
    const start = new Date(startIso).getTime();
    const total = Math.max(1, (end - start));

    const $cd = document.getElementById('countdown');
    const $ring = document.getElementById('sub-ring');
    const $bar  = document.getElementById('bar-progress');

    function tick(){
      const now = Date.now();
      const left = Math.max(0, end - now);
      const pctLeft = Math.round((left / total) * 100);

      // text
      const d  = Math.floor(left / 86400000);
      const h  = Math.floor((left % 86400000) / 3600000);
      const m  = Math.floor((left % 3600000) / 60000);
      if($cd){
        $cd.textContent = (left <= 0) ? "{{ _('Expired') }}" : `${d}d ${h}h ${m}m`;
      }

      // ring
      if($ring){
        $ring.style.background = `conic-gradient(#10b981 ${pctLeft}%, rgba(16,185,129,.15) 0)`;
      }
      if($bar){
        $bar.style.width = `${pctLeft}%`;
      }

      if(left <= 0) clearInterval(iv);
    }

    tick();
    const iv = setInterval(tick, 1000);
  })();
</script>
{% endblock %}
